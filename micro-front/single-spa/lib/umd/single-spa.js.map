{"version":3,"file":"single-spa.js","sources":["../../src/applications/app.helpers.js","../../src/start.js","../../src/lifecycles/load.js","../../src/lifecycles/unmount.js","../../src/lifecycles/bootstrap.js","../../src/lifecycles/mount.js","../../src/navigations/navigator-events.js","../../src/navigations/reroute.js","../../src/applications/app.js"],"sourcesContent":["// 描述应用生命周期\n\nexport const NOT_LOADED = 'NOT_LOADED';  // 应用初始状态\nexport const LOADING_SOURCE_CODE = 'LOADING_SOURCE_CODE';  // 加载资源中\nexport const NOT_BOOTSTRAPPED = 'NOT_BOOTSTRAPPED';  // 还未调用bootstrap方法\nexport const BOOTSTRAPPING = 'BOOTSTRAPPING'; // 启动中\nexport const NOT_MOUNTED = 'NOT_MOUNTED';   // 还未调用mount方法挂载\nexport const MOUNTING = 'MOUNTING';     // 挂载中\nexport const MOUNTED = 'MOUNTED';       // 已挂载\nexport const UPDATING = 'UPDATING';     // 更新中\nexport const UNMOUNTING = 'UNMOUNTING'; // 卸载中\nexport const UNLOADING = 'UNLOADING';   // 完全卸载中\nexport const LOAD_ERR = 'LOAD_ERR';     // load错误\nexport const SKIP_BECAUSE_BROKEN = 'SKIP_BECAUSE_BROKEN';\n\n\nexport function isActive(app) {\n    return app.status === MOUNTED;\n}\n\nexport function shouldBeActive(app) {\n    return app.activeWhen(window.location);\n}","import { reroute } from \"./navigations/reroute\";\n\nexport let started = false;\nexport function start() {\n    started = true;\n    reroute();\n}","import { LOADING_SOURCE_CODE, NOT_BOOTSTRAPPED } from \"../applications/app.helpers\";\n\n\nfunction flattenFnArray(fns) {\n    fns = Array.isArray(fns) ? fns : [fns];\n\n    return function(props) {\n        // Promise.resolve().then(() => fn1(props)).then(() => fn2(props));\n        return (props) => fns.reduce((p, fn) => p.then(() => fn(props)), Promise.resolve());\n    }\n}\nexport async function toLoadPromise(app) {\n    if (app.loadPromise) {\n        return app.loadPromise;\n    }\n\n    return app.loadPromise = Promise.resolve().then(async () => {\n        app.status = LOADING_SOURCE_CODE;\n        let { bootstrap, mount, unmount } = await app.loadApp(app.customProps);\n        app.status = NOT_BOOTSTRAPPED;\n        // 多个promise链式组合\n        app.bootstrap = flattenFnArray(bootstrap);\n        app.mount = flattenFnArray(mount);\n        app.unmount = flattenFnArray(unmount);\n\n        delete app.loadPromise;\n        return app;\n    })\n}","import { MOUNTED, UNMOUNTING, NOT_MOUNTED } from \"../applications/app.helpers\";\n\nexport async function toUnmountPromise(app) {\n    if (app.status !== MOUNTED) {\n        return app;\n    }\n\n    app.status = UNMOUNTING;\n    await app.unmount(app.customProps);\n    app.status = NOT_MOUNTED;\n\n    return app;\n}","import { NOT_BOOTSTRAPPED, BOOTSTRAPPING, NOT_MOUNTED } from \"../applications/app.helpers\";\n\nexport async function toBootstrapPromise(app) {\n    if (app !== NOT_BOOTSTRAPPED) {\n        return app;\n    }\n\n    app.status = BOOTSTRAPPING;\n    app.bootstrap(app.customProps);\n    app.status = NOT_MOUNTED;\n\n    return app;\n}","import { NOT_MOUNTED, MOUNTING, MOUNTED } from \"../applications/app.helpers\";\n\nexport async function toMountPromise(app) {\n    if (app.status !== NOT_MOUNTED) {\n        return app;\n    }\n\n    app.status = MOUNTING;\n    await app.mount(app.customProps);\n    app.status = MOUNTED;\n\n    return app;\n}","import { reroute } from \"./reroute\";\n\n\nexport const routingEventsListeningTo = ['hashchange', 'popstate'];\n\nfunction urlReroute() {\n    reroute([], arguments);\n}\n\nconst capturedEventListeners = {\n    hashchange: [],\n    popstate: []\n}\n\nwindow.addEventListener('hashchange', urlReroute);\nwindow.addEventListener('popstate', urlReroute);\n\nconst originalAddEventListener = window.addEventListener;\nconst originalRemoveEventListener = window.removeEventListener;\n\nwindow.addEventListener = function(eventName, fn) {\n    if (routingEventsListeningTo.indexOf(eventName) >= 0 && !capturedEventListeners[eventName].some(listener => listener == fn)) {\n        capturedEventListeners[eventName].push(fn);\n        return;\n    }\n\n    return originalAddEventListener.apply(this, arguments);\n}\n\nwindow.removeEventListener = function(eventName, fn) {\n    if (routingEventsListeningTo.indexOf(eventName) >= 0) {\n        capturedEventListeners[eventName] = capturedEventListeners[eventName].filter(l => l !== fn);\n        return;\n    }\n    return originalRemoveEventListener.apply(this, arguments);\n}\n\nfunction patchedUpdateState(updateState, methodName) {\n    return function() {\n        const urlBefore = window.location.href;\n        updateState.apply(this, arguments);\n        const urlAfter = window.location.href;\n\n        if (urlBefore !== urlAfter) {\n            urlReroute(new PopStateEvent('popstate'));\n        }\n    }\n}\n\nwindow.history.pushState = patchedUpdateState(window.history.pushState, 'pushState');\nwindow.history.popstate = patchedUpdateState(window.history.popstate, 'popState');","import { started } from \"../start\";\nimport { getAppChanges } from \"../applications/app\";\nimport { toLoadPromise } from \"../lifecycles/load\";\nimport { toUnmountPromise } from \"../lifecycles/unmount\";\nimport { toBootstrapPromise } from \"../lifecycles/bootstrap\";\nimport { toMountPromise } from \"../lifecycles/mount\";\n\nimport './navigator-events'\n\nexport function reroute() {\n\n    const { appsToLoad, appsToMount, appsToUnmount } = getAppChanges();\n\n    if (started) {\n\n        return performAppChanges();\n    } else {\n\n        return loadApps();\n    }\n\n    async function loadApps() {\n        let apps = await Promise.all(appsToLoad.map(toLoadPromise));\n    }\n\n    async function performAppChanges() {\n        // 先卸载应用\n        let unmountPromises = appsToUnmount.map(toUnmountPromise);\n\n        appsToLoad.map(async (app) => {\n            app = await toLoadPromise(app);\n            app = await toBootstrapPromise(app);\n            return toMountPromise(app);;\n        })\n\n        appsToMount.map(async (app) => {\n            app = await toBootstrapPromise(app);\n            return toMountPromise(app);\n        })\n    }\n}\n\n","import { NOT_LOADED, shouldBeActive, NOT_BOOTSTRAPPED, BOOTSTRAPPING, NOT_MOUNTED, MOUNTED } from \"./app.helpers\";\nimport { reroute } from \"../navigations/reroute\";\n\n\nconst apps = [];\nexport function registerApplication(appName, loadApp, activeWhen, customProps) {\n    apps.push({\n        appName,\n        loadApp,\n        activeWhen,\n        customProps,\n        status: NOT_LOADED\n    })\n\n    reroute();\n}\n\nexport function getAppChanges() {\n    const appsToLoad = [];\n    const appsToMount = [];\n    const appsToUnmount = [];\n\n    apps.forEach(app => {\n        const shouldActive = shouldBeActive(app);\n\n        switch (app.status) {\n            case NOT_LOADED:\n            case LOADING_SOURCE_CODE:\n                if (shouldActive) {\n                    appsToLoad.push(app);\n                }\n                break;\n            case NOT_BOOTSTRAPPED:\n            case BOOTSTRAPPING:\n            case NOT_MOUNTED:\n                if (shouldActive) {\n                    appsToMount.push(app);\n                }\n                break;\n            case MOUNTED:\n                if (!shouldActive) {\n                    appsToUnmount.push(app);\n                }\n        }\n    })\n\n    return {\n        appsToLoad,\n        appsToMount,\n        appsToUnmount\n    }\n}"],"names":["LOADING_SOURCE_CODE"],"mappings":";;;;;;IAAA;AACA;IACO,MAAM,UAAU,GAAG,YAAY,CAAC;IAChC,MAAMA,qBAAmB,GAAG,qBAAqB,CAAC;IAClD,MAAM,gBAAgB,GAAG,kBAAkB,CAAC;IAC5C,MAAM,aAAa,GAAG,eAAe,CAAC;IACtC,MAAM,WAAW,GAAG,aAAa,CAAC;IAClC,MAAM,QAAQ,GAAG,UAAU,CAAC;IAC5B,MAAM,OAAO,GAAG,SAAS,CAAC;IAE1B,MAAM,UAAU,GAAG,YAAY,CAAC;AASvC;IACO,SAAS,cAAc,CAAC,GAAG,EAAE;IACpC,IAAI,OAAO,GAAG,CAAC,UAAU,CAAC,MAAM,CAAC,QAAQ,CAAC,CAAC;IAC3C;;ICpBO,IAAI,OAAO,GAAG,KAAK,CAAC;IACpB,SAAS,KAAK,GAAG;IACxB,IAAI,OAAO,GAAG,IAAI,CAAC;IACnB,IAAI,OAAO,EAAE,CAAC;IACd;;ICHA,SAAS,cAAc,CAAC,GAAG,EAAE;IAC7B,IAAI,GAAG,GAAG,KAAK,CAAC,OAAO,CAAC,GAAG,CAAC,GAAG,GAAG,GAAG,CAAC,GAAG,CAAC,CAAC;AAC3C;IACA,IAAI,OAAO,SAAS,KAAK,EAAE;IAC3B;IACA,QAAQ,OAAO,CAAC,KAAK,KAAK,GAAG,CAAC,MAAM,CAAC,CAAC,CAAC,EAAE,EAAE,KAAK,CAAC,CAAC,IAAI,CAAC,MAAM,EAAE,CAAC,KAAK,CAAC,CAAC,EAAE,OAAO,CAAC,OAAO,EAAE,CAAC,CAAC;IAC5F,KAAK;IACL,CAAC;IACM,eAAe,aAAa,CAAC,GAAG,EAAE;IACzC,IAAI,IAAI,GAAG,CAAC,WAAW,EAAE;IACzB,QAAQ,OAAO,GAAG,CAAC,WAAW,CAAC;IAC/B,KAAK;AACL;IACA,IAAI,OAAO,GAAG,CAAC,WAAW,GAAG,OAAO,CAAC,OAAO,EAAE,CAAC,IAAI,CAAC,YAAY;IAChE,QAAQ,GAAG,CAAC,MAAM,GAAGA,qBAAmB,CAAC;IACzC,QAAQ,IAAI,EAAE,SAAS,EAAE,KAAK,EAAE,OAAO,EAAE,GAAG,MAAM,GAAG,CAAC,OAAO,CAAC,GAAG,CAAC,WAAW,CAAC,CAAC;IAC/E,QAAQ,GAAG,CAAC,MAAM,GAAG,gBAAgB,CAAC;IACtC;IACA,QAAQ,GAAG,CAAC,SAAS,GAAG,cAAc,CAAC,SAAS,CAAC,CAAC;IAClD,QAAQ,GAAG,CAAC,KAAK,GAAG,cAAc,CAAC,KAAK,CAAC,CAAC;IAC1C,QAAQ,GAAG,CAAC,OAAO,GAAG,cAAc,CAAC,OAAO,CAAC,CAAC;AAC9C;IACA,QAAQ,OAAO,GAAG,CAAC,WAAW,CAAC;IAC/B,QAAQ,OAAO,GAAG,CAAC;IACnB,KAAK,CAAC;IACN;;IC1BO,eAAe,gBAAgB,CAAC,GAAG,EAAE;IAC5C,IAAI,IAAI,GAAG,CAAC,MAAM,KAAK,OAAO,EAAE;IAChC,QAAQ,OAAO,GAAG,CAAC;IACnB,KAAK;AACL;IACA,IAAI,GAAG,CAAC,MAAM,GAAG,UAAU,CAAC;IAC5B,IAAI,MAAM,GAAG,CAAC,OAAO,CAAC,GAAG,CAAC,WAAW,CAAC,CAAC;IACvC,IAAI,GAAG,CAAC,MAAM,GAAG,WAAW,CAAC;AAC7B;IACA,IAAI,OAAO,GAAG,CAAC;IACf;;ICVO,eAAe,kBAAkB,CAAC,GAAG,EAAE;IAC9C,IAAI,IAAI,GAAG,KAAK,gBAAgB,EAAE;IAClC,QAAQ,OAAO,GAAG,CAAC;IACnB,KAAK;AACL;IACA,IAAI,GAAG,CAAC,MAAM,GAAG,aAAa,CAAC;IAC/B,IAAI,GAAG,CAAC,SAAS,CAAC,GAAG,CAAC,WAAW,CAAC,CAAC;IACnC,IAAI,GAAG,CAAC,MAAM,GAAG,WAAW,CAAC;AAC7B;IACA,IAAI,OAAO,GAAG,CAAC;IACf;;ICVO,eAAe,cAAc,CAAC,GAAG,EAAE;IAC1C,IAAI,IAAI,GAAG,CAAC,MAAM,KAAK,WAAW,EAAE;IACpC,QAAQ,OAAO,GAAG,CAAC;IACnB,KAAK;AACL;IACA,IAAI,GAAG,CAAC,MAAM,GAAG,QAAQ,CAAC;IAC1B,IAAI,MAAM,GAAG,CAAC,KAAK,CAAC,GAAG,CAAC,WAAW,CAAC,CAAC;IACrC,IAAI,GAAG,CAAC,MAAM,GAAG,OAAO,CAAC;AACzB;IACA,IAAI,OAAO,GAAG,CAAC;IACf;;ICTO,MAAM,wBAAwB,GAAG,CAAC,YAAY,EAAE,UAAU,CAAC,CAAC;AACnE;IACA,SAAS,UAAU,GAAG;IACtB,IAAI,OAAO,CAAc,CAAC,CAAC;IAC3B,CAAC;AACD;IACA,MAAM,sBAAsB,GAAG;IAC/B,IAAI,UAAU,EAAE,EAAE;IAClB,IAAI,QAAQ,EAAE,EAAE;IAChB,EAAC;AACD;IACA,MAAM,CAAC,gBAAgB,CAAC,YAAY,EAAE,UAAU,CAAC,CAAC;IAClD,MAAM,CAAC,gBAAgB,CAAC,UAAU,EAAE,UAAU,CAAC,CAAC;AAChD;IACA,MAAM,wBAAwB,GAAG,MAAM,CAAC,gBAAgB,CAAC;IACzD,MAAM,2BAA2B,GAAG,MAAM,CAAC,mBAAmB,CAAC;AAC/D;IACA,MAAM,CAAC,gBAAgB,GAAG,SAAS,SAAS,EAAE,EAAE,EAAE;IAClD,IAAI,IAAI,wBAAwB,CAAC,OAAO,CAAC,SAAS,CAAC,IAAI,CAAC,IAAI,CAAC,sBAAsB,CAAC,SAAS,CAAC,CAAC,IAAI,CAAC,QAAQ,IAAI,QAAQ,IAAI,EAAE,CAAC,EAAE;IACjI,QAAQ,sBAAsB,CAAC,SAAS,CAAC,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC;IACnD,QAAQ,OAAO;IACf,KAAK;AACL;IACA,IAAI,OAAO,wBAAwB,CAAC,KAAK,CAAC,IAAI,EAAE,SAAS,CAAC,CAAC;IAC3D,EAAC;AACD;IACA,MAAM,CAAC,mBAAmB,GAAG,SAAS,SAAS,EAAE,EAAE,EAAE;IACrD,IAAI,IAAI,wBAAwB,CAAC,OAAO,CAAC,SAAS,CAAC,IAAI,CAAC,EAAE;IAC1D,QAAQ,sBAAsB,CAAC,SAAS,CAAC,GAAG,sBAAsB,CAAC,SAAS,CAAC,CAAC,MAAM,CAAC,CAAC,IAAI,CAAC,KAAK,EAAE,CAAC,CAAC;IACpG,QAAQ,OAAO;IACf,KAAK;IACL,IAAI,OAAO,2BAA2B,CAAC,KAAK,CAAC,IAAI,EAAE,SAAS,CAAC,CAAC;IAC9D,EAAC;AACD;IACA,SAAS,kBAAkB,CAAC,WAAW,EAAE,UAAU,EAAE;IACrD,IAAI,OAAO,WAAW;IACtB,QAAQ,MAAM,SAAS,GAAG,MAAM,CAAC,QAAQ,CAAC,IAAI,CAAC;IAC/C,QAAQ,WAAW,CAAC,KAAK,CAAC,IAAI,EAAE,SAAS,CAAC,CAAC;IAC3C,QAAQ,MAAM,QAAQ,GAAG,MAAM,CAAC,QAAQ,CAAC,IAAI,CAAC;AAC9C;IACA,QAAQ,IAAI,SAAS,KAAK,QAAQ,EAAE;IACpC,YAAY,UAAU,CAAC,IAAI,aAAa,CAAC,UAAU,CAAC,CAAC,CAAC;IACtD,SAAS;IACT,KAAK;IACL,CAAC;AACD;IACA,MAAM,CAAC,OAAO,CAAC,SAAS,GAAG,kBAAkB,CAAC,MAAM,CAAC,OAAO,CAAC,SAAsB,CAAC,CAAC;IACrF,MAAM,CAAC,OAAO,CAAC,QAAQ,GAAG,kBAAkB,CAAC,MAAM,CAAC,OAAO,CAAC,QAAoB,CAAC;;ICzC1E,SAAS,OAAO,GAAG;AAC1B;IACA,IAAI,MAAM,EAAE,UAAU,EAAE,WAAW,EAAE,aAAa,EAAE,GAAG,aAAa,EAAE,CAAC;AACvE;IACA,IAAI,IAAI,OAAO,EAAE;AACjB;IACA,QAAQ,OAAO,iBAAiB,EAAE,CAAC;IACnC,KAAK,MAAM;AACX;IACA,QAAQ,OAAO,QAAQ,EAAE,CAAC;IAC1B,KAAK;AACL;IACA,IAAI,eAAe,QAAQ,GAAG;IAC9B,QAAQ,IAAI,IAAI,GAAG,MAAM,OAAO,CAAC,GAAG,CAAC,UAAU,CAAC,GAAG,CAAC,aAAa,CAAC,CAAC,CAAC;IACpE,KAAK;AACL;IACA,IAAI,eAAe,iBAAiB,GAAG;IACvC;IACA,QAAQ,IAAI,eAAe,GAAG,aAAa,CAAC,GAAG,CAAC,gBAAgB,CAAC,CAAC;AAClE;IACA,QAAQ,UAAU,CAAC,GAAG,CAAC,OAAO,GAAG,KAAK;IACtC,YAAY,GAAG,GAAG,MAAM,aAAa,CAAC,GAAG,CAAC,CAAC;IAC3C,YAAY,GAAG,GAAG,MAAM,kBAAkB,CAAC,GAAG,CAAC,CAAC;IAChD,YAAY,OAAO,cAAc,CAAC,GAAG,CAAC,CACtC,SAAS,EAAC;AACV;IACA,QAAQ,WAAW,CAAC,GAAG,CAAC,OAAO,GAAG,KAAK;IACvC,YAAY,GAAG,GAAG,MAAM,kBAAkB,CAAC,GAAG,CAAC,CAAC;IAChD,YAAY,OAAO,cAAc,CAAC,GAAG,CAAC,CAAC;IACvC,SAAS,EAAC;IACV,KAAK;IACL;;ICpCA,MAAM,IAAI,GAAG,EAAE,CAAC;IACT,SAAS,mBAAmB,CAAC,OAAO,EAAE,OAAO,EAAE,UAAU,EAAE,WAAW,EAAE;IAC/E,IAAI,IAAI,CAAC,IAAI,CAAC;IACd,QAAQ,OAAO;IACf,QAAQ,OAAO;IACf,QAAQ,UAAU;IAClB,QAAQ,WAAW;IACnB,QAAQ,MAAM,EAAE,UAAU;IAC1B,KAAK,EAAC;AACN;IACA,IAAI,OAAO,EAAE,CAAC;IACd,CAAC;AACD;IACO,SAAS,aAAa,GAAG;IAChC,IAAI,MAAM,UAAU,GAAG,EAAE,CAAC;IAC1B,IAAI,MAAM,WAAW,GAAG,EAAE,CAAC;IAC3B,IAAI,MAAM,aAAa,GAAG,EAAE,CAAC;AAC7B;IACA,IAAI,IAAI,CAAC,OAAO,CAAC,GAAG,IAAI;IACxB,QAAQ,MAAM,YAAY,GAAG,cAAc,CAAC,GAAG,CAAC,CAAC;AACjD;IACA,QAAQ,QAAQ,GAAG,CAAC,MAAM;IAC1B,YAAY,KAAK,UAAU,CAAC;IAC5B,YAAY,KAAK,mBAAmB;IACpC,gBAAgB,IAAI,YAAY,EAAE;IAClC,oBAAoB,UAAU,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;IACzC,iBAAiB;IACjB,gBAAgB,MAAM;IACtB,YAAY,KAAK,gBAAgB,CAAC;IAClC,YAAY,KAAK,aAAa,CAAC;IAC/B,YAAY,KAAK,WAAW;IAC5B,gBAAgB,IAAI,YAAY,EAAE;IAClC,oBAAoB,WAAW,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;IAC1C,iBAAiB;IACjB,gBAAgB,MAAM;IACtB,YAAY,KAAK,OAAO;IACxB,gBAAgB,IAAI,CAAC,YAAY,EAAE;IACnC,oBAAoB,aAAa,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;IAC5C,iBAAiB;IACjB,SAAS;IACT,KAAK,EAAC;AACN;IACA,IAAI,OAAO;IACX,QAAQ,UAAU;IAClB,QAAQ,WAAW;IACnB,QAAQ,aAAa;IACrB,KAAK;IACL;;;;;;;;;;;;;"}